<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::content})}">

<head>
    <title>Nueva Reserva</title>
</head>

<body>
    <div th:fragment="content">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h4 class="my-0 fw-normal">Crear Nueva Reserva</h4>
                    </div>
                    <div class="card-body">
                        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                        <form th:action="@{/reservas/crear}" method="post">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sala" class="form-label">1. Seleccione una Sala:</label>
                                    <select id="sala" name="salaId" class="form-select" required>
                                        <option value="">-- Elija una sala --</option>
                                        <option th:each="sala : ${salas}" th:value="${sala.id}" th:text="${sala.nombre}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="fecha" class="form-label">2. Seleccione una Fecha:</label>
                                    <input type="date" id="fecha" name="fecha" class="form-control" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="hora" class="form-label">3. Seleccione una Hora:</label>
                                <select id="hora" name="hora" class="form-select" required>
                                    <option value="">-- Elija una sala y fecha primero --</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">4. Artículos Adicionales (Opcional):</label>
                                <div class="border rounded p-3">
                                    <div th:each="articulo : ${articulos}" class="form-check">
                                        <input type="checkbox" class="form-check-input articulo-checkbox" th:id="'articulo-' + ${articulo.id}" name="articulosIds" th:value="${articulo.id}" th:data-permanently-disabled="!${articulo.disponible}">
                                        <label class="form-check-label" th:for="'articulo-' + ${articulo.id}" th:text="${articulo.nombre}"></label>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <a th:href="@{/dashboard}" class="btn btn-secondary me-2">Cancelar</a>
                                <button type="submit" class="btn btn-primary">Crear Reserva</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const salaSelect = document.getElementById('sala');
                const fechaInput = document.getElementById('fecha');
                const horaSelect = document.getElementById('hora');
                const articulosCheckboxes = document.querySelectorAll('.articulo-checkbox');

                function actualizarDisponibilidadArticulos() {
                    const fecha = fechaInput.value;
                    const hora = horaSelect.value;

                    // Primero, resetear todos los checkboxes a su estado original (respetando los permanentemente deshabilitados)
                    articulosCheckboxes.forEach(checkbox => {
                        const isPermanentlyDisabled = checkbox.getAttribute('data-permanently-disabled') === 'true';
                        checkbox.disabled = isPermanentlyDisabled;
                        checkbox.parentElement.classList.remove('text-muted');
                        if(isPermanentlyDisabled) checkbox.parentElement.classList.add('text-muted');
                    });

                    if (!fecha || !hora) return;

                    // Llamada a la nueva API para ver qué artículos están ocupados
                    fetch(`/api/reservas/articulos-ocupados?fecha=${fecha}&hora=${hora}`)
                        .then(response => response.json())
                        .then(ocupadosIds => {
                            articulosCheckboxes.forEach(checkbox => {
                                const articuloId = parseInt(checkbox.value, 10);
                                if (ocupadosIds.includes(articuloId)) {
                                    checkbox.disabled = true;
                                    checkbox.checked = false; // Desmarcar si estaba seleccionado
                                    checkbox.parentElement.classList.add('text-muted');
                                }
                            });
                        })
                        .catch(error => console.error('Error al cargar disponibilidad de artículos:', error));
                }

                function actualizarHorariosDisponibles() {
                    const salaId = salaSelect.value;
                    const fecha = fechaInput.value;

                    if (!salaId || !fecha) {
                        horaSelect.innerHTML = '<option value="">-- Elija una sala y fecha primero --</option>';
                        actualizarDisponibilidadArticulos(); // Resetear artículos si no hay fecha/sala
                        return;
                    }

                    fetch(`/api/reservas/horarios-ocupados?salaId=${salaId}&fecha=${fecha}`)
                        .then(response => response.json())
                        .then(horariosOcupados => {
                            const horaPreviamenteSeleccionada = horaSelect.value;
                            horaSelect.innerHTML = '';

                            const horaActual = new Date().getHours();
                            const fechaSeleccionada = new Date(fecha + 'T00:00:00');
                            const hoy = new Date();
                            hoy.setHours(0, 0, 0, 0);

                            let horariosDisponibles = 0;
                            for (let i = 8; i <= 17; i++) {
                                const esHorarioPasado = (fechaSeleccionada.getTime() === hoy.getTime() && i <= horaActual);
                                if (!horariosOcupados.includes(i) && !esHorarioPasado) {
                                    const option = document.createElement('option');
                                    option.value = i;
                                    option.textContent = i + ':00 - ' + (i + 1) + ':00';
                                    horaSelect.appendChild(option);
                                    horariosDisponibles++;
                                }
                            }

                            if (horariosDisponibles === 0) {
                                horaSelect.innerHTML = '<option value="">-- No hay horarios disponibles --</option>';
                            } else {
                                // Intentar re-seleccionar la hora que estaba antes si aún está disponible
                                if (Array.from(horaSelect.options).some(opt => opt.value === horaPreviamenteSeleccionada)) {
                                    horaSelect.value = horaPreviamenteSeleccionada;
                                }
                            }
                            
                            // Una vez actualizados los horarios, comprobar la disponibilidad de artículos
                            actualizarDisponibilidadArticulos();
                        })
                        .catch(error => console.error('Error al cargar horarios:', error));
                }

                // Event Listeners
                salaSelect.addEventListener('change', actualizarHorariosDisponibles);
                fechaInput.addEventListener('change', actualizarHorariosDisponibles);
                horaSelect.addEventListener('change', actualizarDisponibilidadArticulos);

                // Inicialización
                const hoy = new Date().toISOString().split('T')[0];
                fechaInput.setAttribute('min', hoy);
                actualizarDisponibilidadArticulos(); // Para deshabilitar los permanentemente no disponibles al cargar
            });
        </script>
    </div>
</body>
</html>